<div dir="rtl">

# آموزش کامل آپاچی

## آپاچی چیست

آپاچی ابزاری برای مجهز کردن یک سرور به درگاه Http  یا HTTPS هست

توسط این ابزار میتوانیم کاری کنیم که هر کسی اگر ip address ما رو زد و یا domain name ما رو داشت redirect بشه به DocumentRoot یی که برای اون دامین تعریف کردیم

آپاچی یکی از معروف ترین ابزارهای HTTP برای سرورها هست

در اینجا به علت اینکه ویندوز 10 مجهز به لینوکس شده میتوان آموزش رو یکسان انجام داد

## روش نصب آپاچی بر روی لینوکس و لینوکس ویندوز

برای نصب کافی هست که در ترمینال بنویسیم

<div dir="ltr">

```
sudo apt install apache2 -y
```
</div>

و برای اینکه آپاچی خودمون رو بر روی سیستم ران کنیم مینویسیم

و ورژنی که باید سیستم بتواند بر روی سیستم شما نصب کند 2.4 و یا جدیدتر
<div dir="ltr">

```
sudo service apache2 start
```
</div>

## دستورات مورد نیاز برای آپاچی
ابتدا بهتر هست که با یک سری دستورات در ترمینال آشنا بشیم که در آینده بسیار قراره ازشون استفاده کنیم

قطعا یکی از راه های استارت کردن آپاچی و یا ری استارت کردن توسط دستور `Service` هست اما دستور دیگری وجود دارد به نام `apachectl` که میتواند همین کار و کارهای دیگر رو انجام دهد کافی هست که این دستور رو درون ترمینال وارد کنید که خودش به شما میگه که چه کارهایی رو میتوان انجام داد

### ری استارت و یا استارت و یا متوقف کردن آپاچی

کافی هست برای اینکار بنویسیم
<div dir="ltr">

```
sudo apachectl start | stop | restart
```
</div>

### گرفتن اطلاعات و یا اطلاعات بیشتر درمورد مشکل پیش رو در آپاچی

بعضی اوقات ممکن هست که شما دچار مشکلاتی بشید یا میخواهید وضعیت آپاچی خودتون رو بدونید کافی هست که برای این دستورات بنویسید

<div dir="ltr">

```
sudo apachectl status | fullstatus | configtest
```
</div>
به طور مثال با دستور `configtest` میتونید از مشکلات در syntax فایل ها متوجه بشید و یا اگر نوشت syntax ok به معنی آن هست که آپاچی شما مشکل نوشتاری ندارد

### چگونه متوجه بشید که چه ماژولی بر روی سیستم آپاچی شما نصب هست

کافی هست که دستور زیر رو اجرا کنید که متوجه بشید چه ماژولی در حال حاظر فعال هست

<div dir="ltr">

```
sudo apachectl -M
```
</div>

### چگونه ماژولی رو فعال و یا غیر فعال کنیم

اگر دقت کرده باشید درون دایرکتوری `apache2` شما دو پوشه به نام های `mods-enabled` و `mods-avaliable` داریم 

دایرکتوری `mods-avaliable` دایرکتوری هست که تمام ماژول ها و افزونه های آپاچی درون اونجا قرار داره که غیر فعال هستند و اگر بخواهیم اونها رو فعال کنیم باید وارد دایرکتوری `mods-enabled` بکنیم

برای اینکار کافی هست بنویسیم

<div dir="ltr">

```
sudo a2enmod <module name>

for example

sudo a2enmod deflate
```
</div>

دستور a2enmod کمی عجیب میاد اما باید بدونیم که این دستور مخفف جمله `apache2 enable module` هست

و برای غیر فعال کردن ماژولی مینویسیم

<div dir="ltr">

```
sudo a2dismod <module name>
```
</div>

این دستور هم مخفف جمله `apache2 disable module` هست
### چگونه از ورژن آپاچی خودمون مطلع بشویم

برای اینکار کافی هست از دستور زیر برای اینکار استفاده کنیم

<div dir="ltr">

```
sudo apachectl -v
```
</div>

## فایل های configuration  در اپاچی چیست؟

به مهم ترین بخش آپاچی وارد میشیم یعنی جایی که 90 درصد کارمون در این مکان ها هست 

آپاچی از سه فایل اصلی از شما پذیرایی میکنه برای نوشتن تمامی دستورات مورد نظر خودتون

که به شرح زیر است 

<div dir="ltr">
1- apache2.conf

2- ports.conf

3- 000-default.conf
</div>

فایل اول یا همون `apache2.conf` فایلی هست که تمامی دستورات گلوبال و عمومی آپاچی درون اونجا نوشته میشود

پس اگر یک زمانی دستوری رو میخواهیم برای همه اجرا شود رو درون این فایل مینویسیم

فایل دوم یا همون `ports.conf` فایلی هست که به ما اجازه میده برای آپاچی پورتی رو باز کنیم به طور مثال من میخوام دو وب سایت رو از یک آی پی اما با دو پورت متفاوت اجرا کنم که تمام اینها درون این مکان نوشته میشود.

و فایل آخر یا همون `000-default.conf` که مکانی برای ایجاد هر نوع وب سایت که میخواهیم بر روی سیستم لود شود و مهم ترین بخش این آپاچی محسوب میشود

آپاچی بسیار گسترده هست به همین دلیل ما بر اساس نیاز خودمون در آپاچی به جلو میریم

## چگون پورتی رو برای آپاچی باز کنیم

به طور مثال من میخوام یک وب سایت رو بر روی پورت 1875 با آی پی 192.168.1.140 باز کنم که هر کسی با این آی پی و با این پورت وارد شد منتقل بشه به دایرکتوری و یا وب سایت که من میگم

برای اینکار کافی هست که وارد این مکان بشیم `/etc/apache2/ports.conf` و در این مکان پورت مورد نظر خودمون رو تعریف کنیم

برای اینکار از دستور `Listen` استفاده میکنیم

پس مینویسیم

<div dir="ltr">

```
Listen 1875
```
</div>
یا اگر میخواهیم کمی بیشتر specific باشیم آی پی رو هم درج میکنیم

<div dir="ltr">

```
Listen 192.168.1.140:1875
```
</div>
و یا حتی میتونیم درگاه هم مشخص کنیم یعنی بگوییم که اگر فرد تنها `https` وارد کرد میتونه وارد بشه
<div dir="ltr">

```
Listen 192.168.1.140:1875 https
```
</div>

## چگونه امنیت آپاچی خود را افزایش دهیم

اولین قدم این هست که بدونیم آپاچی هنگامی که ErrorDocument یی رو نشون میده همیشه اطلاعات سیستم عامل و ورژن آپاچی مورد نظر رو نشون میده

بریم اول با دایرکتوری `conf-avaliable` و `conf-enabled` آشنا بشیم

این دو دایرکتوری درون خودشون یک سری فایل هایی برای کانفیگ کردن آپاچی دارن از جمله `security.conf` که به ما اجازه میده امنیت آپاچی رو افزایش بدیم

برای اینکار کافی بهتر هست که هر چیزی رو که نیاز داریم از اون فایل به `apache2.conf` انتقال بدیم که برای همه فعال بشه

دو چیز به نام های `ServerTokens` و `ServerSignature` رو وارد فایل `apache2.conf` میکنیم

به اینصورت
<div dir="ltr">

```
ServerSignature off
ServerTokens Prod
```
</div>
با اینکار دیگه کسی نمیتونه بفهمه که من از چه سیستم عاملی و چه آپاچی با چه ورژنی دارم استفاده میکنم

برای تست اینکار کافی هست که وارد وب سایت خودتون بشید و به اشتباه به دایرکتوری برید که وجود نداره به طور مثال

<div dir="ltr">

```
https://mixpanel.dev/info

The requested URL was not found on this server.
```
</div>
اما اگر این دو گزینه فعال نبودن به شما این اطلاعات رو میداد

<div dir="ltr">

```
https://mixpanel.dev/info

Apache/2.4.41 (Ubuntu) Server at mixpanel.dev Port 443
```
</div>

### چگونه بر روی یک Directory درون آپاچی پسورد قرار بدیم

بعضی اوقات دلمون میخواد که بتونیم یک وب سایت یا یک دایرکتوری خاص رو به شرط داشتن یوزرنیم و پسورد بتونیم دسترسی داشته باشیم و اینطوری میتونیم افراد خاص با امنیت بالا وارد بشیم

به طور مثال مثلا من دلم میخواد که بتونم از بیرون به دایرکتوریهای سرورم دست پیدا کنم ولی دلم نمیخواد هر کسی بتونه دسترسی داشته باشه پس میتونم یوزرنیم و پسورد قرار بدم

برای اینکار ابتدا باید با `Directory` آشنا بشیم

این سینتکس که خیلی هم شبیه به اچ تی ام ال هست کارش اینه که برای من محیطی رو ایجاد کنه که من بتونم دستوراتم رو به یک دایرکتوری خاص درون پروژه ای اعمال کنم

به طور مثال دلم میخواد کسی نتونه یک فایلی رو از این دایرکتوری که درون وب سایت هم هست ذخیره کنه و یا میخوام دسترسی بیشتر بدم و حتی دسترسی به Authentication برای یک بخشی از وب سایت ایجاد کنم

به طور مثال در اینجا میخواهیم کاری کنیم که فرد وقتی میخواد وارد وب سایت بشه ازش درخواست پسورد کنه پس کافی هست filesystem این پروژه رو پیدا کنیم و به دایرکتوری بدیم که بتونیم exception های خودمون رو اعمال کنیم

<div dir="ltr">

```
<Directory /mnt/d/mxplan/>
    AuthType Basic
    AuthName 'sorry you need password'
    AuthUserFile /etc/apache2/.htpasswd
    Require valid-user
</Directory>
```
</div>
در ابتدا با نوشتن `AuthType` میگیم که چه نوع از Authentication هایی میخواهیم استفاده کنیم که در اینجا Basic که یک حالت کلی هست استفاده میکنیم

سپس یک مسیجی رو تحت `AuthName` میدیم که به کاربر نشون بده

و سپس آدرس فایل `.htpasswd` رو بهش میدیم که بره گسوردی رو که یوزر داده رو با پسوردی رو که درون سرور ذخیره هست چک کنه و ببینه معتبر هست یا نه

و در نهایت به جای اینکه اجازه بدیم تمام یوزرها وارد بشن از دستور `valid-user` استفاده میکنیم که به معنی آن هست که اگر پسورد رو درست زد اون یک یوزر معتبر هست و اجازه ورود داره

### فایل .htpasswd چیست

این فایل مکانی هست که یوزرنیم و پسورد من درونش ذخیره داده شده که در سرور مورد نظر مورد استفاده قرار بگیره

برای ساخت این فایل ما نیازمند دستور `htpasswd` هستیم که بسیار ساده است

برای اینکار به اینصورت فایل مورد نظر خودمون رو میسازیم
<div dir="ltr">

```
sudo htpasswd -c /path_to/[file_name] <username>
```
</div>

دستور به اینصورت هست که ابتدا از کامند `htpasswd` استفاده میکنیم و سپس از `-c` استفاده میشود که به معنی create هست و بعد آدرس و یا نام فایل رو ایجاد میکنیم و در نهایت یوزرنیم رو وارد میکنیم

و وقتی که اینتر بزنید از شما برای وارد کردن پسورد سوال میشود که شما پسورد مورد نظر رو وارد میکنید و فایل شما برای استفاده آماده هست

<div dir="ltr">

```
sudo htpasswd -c /etc/apache2/.htpasswd illustrayking
```
</div>

## چگونه یک  وب سایت را بر روی آپاچی نصب کنیم

قبل از هر چیزی باید بدونیم یکی دیگه از فواید آپاچی این هست که به ما اجازه میده که بتونیم بیش از یک وب سایت رو بر روی یک ip راه اندازی کنیم

که در اصطلاح میگن `virtual host` هاست مجازی که توسط این هاست ما می تونیم بیش از یک وب سایت رو بر روی یک سرور راه اندازی کنیم

ابتدا باید وارد فایل `000-default.conf` درون دایرکتوری /etc/apache2/sites-enabled وارد بشویم

کافیست توسط یک ادیتور مثل *nano* آن را باز کنیم

<div dir="ltr">

```
sudo nano /etc/apache2/sites-enabled/000-default.conf
```
</div>
قبل از هر چیزی باید بدونیم که این هم یک فایل .conf می باشد یعنی میتونیم تمامی کانفیگ های مورد نیاز خودمون رو هم درون این مکان و در یک جا بنویسیم و به جای اینکه مثلا درون فایل `apache2.conf` بنویسیم

برای اینکه بتونیم وب سایت خودمون رو ایجاد کنیم نیازمند دستور `VirtualHost` هستیم

کافی هست که این تگ رو باز کنیم و بین اون تمامی دستورات خودمون رو بنویسیم این تگ نیازمند دو چیز دیگر هم هست 

1- آی پی که ما میخواهیم روی اون وب سایت رو serve کنیم

2- پورتی که نیازمند هستیم

به طور مثال

<div dir="ltr">

```
<VirtualHost 192.168.0.50:443>

    Your host configurations sit here

</VirtualHost>
```
</div>

ما میدونیم که برای اینکه پورتی رو باز کنیم کافی هست که اون پورت رو داخل `ports.conf` بنویسیم یا بیرون از تگ `VirtualHost` اون رو بنویسیم

به این شکل 

<div dir="ltr">

```
Listen 443

<VirtualHost 192.168.0.50:443>

</VirtualHost>

or

sudo nano /etc/apache2/ports.conf

Listen 443
```
</div>

 به اولین چیزی که نیاز داریم این هست که بگیم این هاست مجازی از کدام دایرکتوری تغذیه میکنه و اصلا فایل `index.html` در کجا قرار دارد

 برای اینکار از `DocumentRoot` استفاده میکنیم

 <div dir="ltr">

```
<VirtualHost 192.168.0.50:443>
    DocumentRoot /mnt/d/server/www/mixpanel/
</VirtualHost>
```
</div>

نیازی نیست که آدرس دقیق فایل index.html رو بدیم کافی هست که فقط آدرس دایرکتوری پروژه رو بدیم و خود آپاچی فایل مورد نظر رو لود میکنه

در قدم بعدی نیازمند `Domain name` برای آی پی حودمون هستیم چون اینطوری هم امنیت افزایش پیدا میکنه و هم به یاد مونده تر هست 

کافی هست بنویسیم

 <div dir="ltr">

```
<VirtualHost 192.168.0.50:443>
    DocumentRoot /mnt/d/server/www/mixpanel/
    ServerName mixpanel.dev
</VirtualHost>
```
</div>
بعضی اوقات ممکن هست که میخواهیم در کنار دامین خودمون از `www` هم استفاده کنیم پس برای اینکار نیازمند `serverAlias` هستیم که بگیم اگر من از این نام هم استفاده کردم یعنی این هاست 

 <div dir="ltr">

```
<VirtualHost 192.168.0.50:443>
    DocumentRoot /mnt/d/server/www/mixpanel/
    ServerName mixpanel.dev
    ServerAlias www.mixpanel.dev
</VirtualHost>
```
</div>

اگر در وضعیت Development هستیم و `www` کار نمیکند کاملا یک چیز طبیعی هست چرا که ما در بستر وب واقعی نیستیم و تنها داریم یک `local host` رو نزدیک میکنیم به یک وضعیت واقعی

### چگونه برای آپاچی LOG ایجاد کنیم
اگر بخواهیم بگوییم یکی از بخش های مهم آپاچی درک کردن LOG هست

ما میتونیم توی آپاچی تمام فعالیت هایی که درون وب سایت ما رخ میده رو ضبط و ثبت کنیم 

لاگ به فایلی میگویند که درون اون اطلاعاتی از فعالیت های یوزر ثبت شده مثل آی پی فرد و یا اینکه آیا موفق شده وب سایت رو لود کنه و یا نه

در کل دو مدل لاگ فایل وجود داره

 <div dir="ltr">
1- Access Log

2- Error Log
</div>
لاگ Access به لاگی میگن که اطلالاعاتی جامع در مورد ورود موفقیت آمیز کاربر به وب سایت رو گزاش میدند

2- و مهم ترین لاگ که `Error Log` هست به ما اطلاعاتی جامع در مورد مشکلاتی که کاربرها با وب سایت برخوردن رو میده و یکی از مهمترین بخش های یک آپاچی هست

برای ایجاد یک لاگ فایل دو روش رو داریم یکی `ErrorLog` و دیگری `CustomLog` هست که میتونه کمک کنه به ما در ساخت لاگ های متفاوت

به همین دلیل درون فایل آپاچی خودمون مینویسیم

 <div dir="ltr">

```
<VirtualHost 192.168.0.50:443>
    ErrorLog /Path_to/FileName
</VirtualHost>
```
</div>
این فایل نیازمند هیچ گونه Extension یی نیست
 <div dir="ltr">

```
<VirtualHost 192.168.0.50:443>
    DocumentRoot /mnt/d/server/www/mixpanel/
    ServerName mixpanel.dev
    ServerAlias www.mixpanel.dev
    ErrorLog /etc/apache2/errorLog
</VirtualHost>
```
</div>

ما میتونیم حتی یک کار جالب تر رو هم انجام بدیم و اینکه به فایل خودمون فرمت خاصی رو بدیم و بگیم حتی چه چیزهایی وارد بشن و به چه شکل باشن

مثلا من دلم میخواد درون این فایل جلوی هر آی پی که میگیره بنویسه 

User Ip : Ip_address

کافی هست برای اینکار دست به `log formatting` بزنیم

برای اینکار از این روش استفاده میکنیم

 <div dir="ltr">

```
<VirtualHost 192.168.0.50:443>
    LogFormat "format_we_want" common name
</VirtualHost>
```
</div>
برای اینکه بدونیم این فرمت لاگ برای کدوم لاگی نوشته شده از یک اسم در آخر سر استفاده میکنیم و اون رو به لاگ مورد نظر میدهیم به شکل زیر

 <div dir="ltr">

```
<VirtualHost 192.168.0.50:443>
    LogFormat "format_we_want" common
    CustomLog /path_to/File_name common
</VirtualHost>
```
</div>
انواع مختلفی از فرمت ها رو میتونیم از لینک زیر پیدا کنیم و استفاده کنیم 

[log_format](http://httpd.apache.org/docs/current/mod/mod_log_config.html)

به طور مثال

 <div dir="ltr">

```
<VirtualHost 192.168.0.50:443>
    DocumentRoot /mnt/d/server/www/mixpanel/
    ServerName mixpanel.dev
    ServerAlias www.mixpanel.dev
    LogFormat "LocalIP: %A Time: %t" common
    customLog /etc/apache2/custom common
</VirtualHost>
```
</div>

برای اینکه بتونیم یک `custom log` ایجاد کنیم یعنی اینکه یک لاگی که نیازداریم اطلاعاتی که ما میخواهیم درونش باشه از دستور `CustomLog` به حای `ErrorLog` استفاده میکنیم

و در آخرسر دستور `ErrorLogFormat` دستوری هست که فرمت دهی رو فقط برای `ErrorLog` ایجاد میکنه و تفاوت هاش در این هست که نیازی به اسم نداره و اینکه یک سری دستورات مثل وجود `%M` که وجود پیغام ارورو هست درون اون وجود داره

مثل مثال زیر

 <div dir="ltr">

```
<VirtualHost 192.168.0.50:443>
    DocumentRoot /mnt/d/server/www/mixpanel/
    ServerName mixpanel.dev
    ServerAlias www.mixpanel.dev
    LogFormat "LocalIP: %A Time: %t" common
    customLog /etc/apache2/custom common
    ErrorLogFormat "Error Message: %M localIp: %A"
    ErrorLog /etc/apache2/error
</VirtualHost>
```
</div>

و در آخر سر چگونه بین پیغام های لاگ فاصله ایجاد کنیم برای اینکار کافی هست که از دستور `\t` که مخفف tab هست و یا `\n` استفاده کنیم برای اینکه به خط بعد پیغام رو بفرستیم

 <div dir="ltr">

```
<VirtualHost 192.168.0.50:443>
    DocumentRoot /mnt/d/server/www/mixpanel/
    ServerName mixpanel.dev
    ServerAlias www.mixpanel.dev
    LogFormat "LocalIP: %A Time: %t" common
    customLog /etc/apache2/custom common
    ErrorLogFormat "Error Message: \t %M  \n localIp: %A"
    ErrorLog /etc/apache2/error
</VirtualHost>
```
</div>

## چگونه یک صفحه ErrorDocument ایجاد کنیم

یکی از مشهورترین صفحات ارور در وب سایت ها صفحه 404 یا همون `not found` هست اما اگر دلمون بخواد به جای اون اروری که خود آپاچی برای همه نوع ارورها نمایش میده یک چیز متفاوت باشه باید چیکار کنیم؟

برای اینکار نیازمند استفاده از `ErrorDocument` هستیم که آدرس داکیومنت مورد نظر رو به این دستور میدیم و میگیم مثلا هر وقت این ارور با این شماره ایجاد شد این داکیوممنت رو ظاهر کن

برای اینکار کافی هست از دستور زیر استفاده کنیم

 <div dir="ltr">

```
<VirtualHost 192.168.0.50:443>
    ErrorDocument <ErrorNumber> /path_to/ErrorDocument
</VirtualHost>
```
</div>

به طور مثال میخوام این داکیومنت هر وقتی که ارور 404 ظاهر شد نمایان بشه

 <div dir="ltr">

```
<VirtualHost 192.168.0.50:443>
    DocumentRoot /mnt/d/server/www/mixpanel/
    ServerName mixpanel.dev
    ServerAlias www.mixpanel.dev

    ErrorDocument 404 https://mixpanel.dev/error/404/

    LogFormat "LocalIP: %A Time: %t" common
    customLog /etc/apache2/custom common
    ErrorLogFormat "Error Message: \t %M  \n localIp: %A"
    ErrorLog /etc/apache2/error
</VirtualHost>
```
</div>
 به این شکل اگر فردی وارد دایرکتوری اشتباه بشه و این دایرکتوری وجود نداشته باشه به اون به شکلی کاملا متفاوت و خلاقانه اروری نمایش داده میشود

 برای ارورهای دیگکه هم میتونیم به طور کامل این شکل رو بسازیم و فقط کافی هست که آدرس و شماره ارور رو داشته باشیم
</div>